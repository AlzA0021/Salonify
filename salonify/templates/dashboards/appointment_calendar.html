{% extends "dashboard_template.html" %}

{% block head %}
    {# ---- Libraries ---- #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    {# ---- Custom Styles ---- #}
    <style>
        body { font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .menu-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .date-display { font-size: 16px; font-weight: 500; display: flex; align-items: center; cursor: pointer; }
        .logo { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        .stylists-container { background: white; padding: 15px 0; border-bottom: 1px solid #e9ecef; }
        .stylists-row { display: flex; gap: 20px; padding: 0 20px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .stylists-row::-webkit-scrollbar { display: none; }
        .stylist-card { display: flex; flex-direction: column; align-items: center; min-width: 80px; text-align: center; cursor: pointer; transition: transform 0.2s ease; }
        .stylist-card:hover { transform: translateY(-2px); }
        .stylist-card.active { color: #667eea; }
        .stylist-avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #e9ecef; object-fit: cover; margin-bottom: 8px; transition: border-color 0.2s ease; }
        .stylist-card.active .stylist-avatar { border-color: #667eea; }
        .stylist-name { font-size: 12px; font-weight: 500; color: #333; white-space: nowrap; }
        .calendar-container { background: white; margin: 0; min-height: calc(100vh - 200px); }
        .time-slots { padding: 20px; position: relative; }
        #timeSlots.loading::after { content: 'در حال بارگذاری...'; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; color: #6c757d; background: rgba(255, 255, 255, 0.8); padding: 20px 30px; border-radius: 10px; }
        .time-slot { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f3f4; }
        .time-label { font-size: 14px; font-weight: 500; color: #666; width: 60px; text-align: left; }
        .time-content { flex: 1; margin-right: 20px; }
        .stylist-slot { flex: 1; min-height: 50px; border: 1px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; position: relative; }
        .stylist-slot.available { cursor: pointer; }
        .stylist-slot.available:hover { background-color: #f8f9ff; border-color: #667eea; }
        .stylist-slot.available::before { content: '+'; color: #ccc; font-size: 20px; font-weight: bold; }
        .time-slot.unavailable .stylist-slot { cursor: not-allowed; border-style: solid; border-color: #e9ecef; background-color: #f8f9fa; }
        .time-slot.time-off .stylist-slot { cursor: not-allowed; border-style: solid; border-color: #ffdbe5; background-color: #fff0f6; }
        .time-slot.time-off::after { content: 'مرخصی'; position: absolute; right: 90px; font-size: 10px; color: #d6336c; font-weight: bold; }
        .appointment { color: white; border: none; padding: 10px 12px; border-radius: 8px; font-size: 12px; text-align: right; width: 100%; height: 100%; min-height: 50px; display: flex; flex-direction: column; justify-content: center; cursor: pointer; transition: transform 0.2s ease; }
        .appointment:hover { transform: scale(1.02); }
        .appointment.paid { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .appointment.unpaid { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .appointment-customer { font-weight: bold; margin-bottom: 2px; }
        .appointment-service { font-size: 10px; opacity: 0.9; }
        .modal-content { border-radius: 15px; border: none; }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); transform: translateY(-1px); }
    </style>
{% endblock head %}

{% block title %}تقویم نوبت‌ها{% endblock title %}

{% block content %}
    <div id="calendar-data-container" data-salon-id="{{ salon_id }}" data-prefix="{{ dashboard_prefix|safe }}"></div>

    <div class="header">
        <div class="header-top">
            <button class="menu-btn"><i class="bi bi-list"></i></button>
            <div class="date-display" id="dateDisplay"><span></span></div>
            <div class="logo">آلیزا</div>
        </div>
        <div class="stylists-container">
            <div class="stylists-row" id="stylistsRow"></div>
        </div>
    </div>

    <input type="text" id="hiddenDatePicker" class="d-none" />

    <div class="calendar-container">
        <div class="time-slots" id="timeSlots"></div>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">ثبت نوبت جدید</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><strong>آرایشگر:</strong> <span id="modalStylist"></span></div>
                    <div class="mb-3"><strong>تاریخ:</strong> <span id="modalDate"></span></div>
                    <div class="mb-3"><strong>ساعت:</strong> <span id="modalTime"></span></div>
                    <hr>
                    <form id="bookingForm">
                        <div class="mb-3"><label for="customerName" class="form-label">نام مشتری</label><input type="text" class="form-control" id="customerName" required></div>
                        <div class="mb-3"><label for="serviceType" class="form-label">نوع خدمت</label><select class="form-select" id="serviceType" required><option value="">انتخاب کنید...</option></select></div>
                        <div class="mb-3"><label for="description" class="form-label">توضیحات (اختیاری)</label><textarea class="form-control" id="description" rows="3"></textarea></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="button" class="btn btn-primary" id="confirmBooking">ثبت نوبت</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="appointmentModalLabel">جزئیات نوبت</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="appointmentDetails"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="cancelAppointment">لغو نوبت</button>
                    <button type="button" class="btn btn-warning" id="editAppointment">ویرایش</button>
                    <button type="button" class="btn btn-success" id="markPaid">پرداخت شده</button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarContainer = document.getElementById('calendar-data-container');
    const salonId = calendarContainer.dataset.salonId;
    const dashboardPrefix = calendarContainer.dataset.prefix;
    const stylists = JSON.parse('{{ stylists_json|safe }}');
    
    let currentDate = new Date();
    let currentStylistId = stylists.length > 0 ? stylists[0].id : null;
    let dailyData = {};

    initializeDatePicker();
    renderStylists();
    fetchAndRenderDay(currentDate);

    function initializeDatePicker() {
        const datePicker = flatpickr("#hiddenDatePicker", {
            defaultDate: currentDate,
            dateFormat: "Y-m-d",
            onChange: function(selectedDates) {
                if (selectedDates.length > 0) {
                    currentDate = selectedDates[0];
                    fetchAndRenderDay(currentDate);
                }
            }
        });
        document.getElementById('dateDisplay').addEventListener('click', () => datePicker.open());
    }

    async function fetchAndRenderDay(date) {
        updateDateDisplay();
        const timeSlotsContainer = document.getElementById('timeSlots');
        timeSlotsContainer.innerHTML = '';
        timeSlotsContainer.classList.add('loading');
        
        const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const url = `${dashboardPrefix}/api/calendar-data/salon/${salonId}/?date=${dateString}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            dailyData = await response.json();
            renderTimeSlots();
        } catch (error) {
            console.error('Failed to fetch calendar data:', error);
            timeSlotsContainer.innerHTML = `<div class="alert alert-danger text-center m-3">خطا در بارگذاری اطلاعات.</div>`;
        } finally {
            timeSlotsContainer.classList.remove('loading');
        }
    }
    
    function updateDateDisplay() {
        const formatter = new Intl.DateTimeFormat('fa-IR', { weekday: 'long', day: 'numeric', month: 'long' });
        document.querySelector('#dateDisplay span').textContent = formatter.format(currentDate);
    }

    function renderStylists() {
        const container = document.getElementById('stylistsRow');
        container.innerHTML = '';
        stylists.forEach(stylist => {
            const card = document.createElement('div');
            card.className = `stylist-card ${stylist.id === currentStylistId ? 'active' : ''}`;
            card.dataset.stylistId = stylist.id;
            card.innerHTML = `<img src="${stylist.avatar}" alt="${stylist.name}" class="stylist-avatar"><div class="stylist-name">${stylist.name}</div>`;
            card.addEventListener('click', function() {
                document.querySelectorAll('.stylist-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentStylistId = this.dataset.stylistId;
                renderTimeSlots();
            });
            container.appendChild(card);
        });
    }

    function renderTimeSlots() {
        const container = document.getElementById('timeSlots');
        container.innerHTML = '';

        if (!dailyData.salonIsOpen) {
            container.innerHTML = `<div class="alert alert-warning text-center m-3">${dailyData.message}</div>`;
            return;
        }

        const slotInterval = 30;
        const dateStr = currentDate.toISOString().split('T')[0];
        const startTime = new Date(`${dateStr}T${dailyData.openTime}`);
        const endTime = new Date(`${dateStr}T${dailyData.closeTime}`);
        
        for (let dt = new Date(startTime); dt < endTime; dt.setMinutes(dt.getMinutes() + slotInterval)) {
            const timeString = dt.toTimeString().substring(0, 5);
            const slotDiv = document.createElement('div');
            
            const appointment = dailyData.appointments.find(app => app.stylistId === currentStylistId && app.time === timeString);
            const { isAvailable, reason } = checkStylistAvailability(timeString);

            let slotStateClass = '', slotContent = '';

            if (appointment) {
                slotContent = `<div class="appointment ${appointment.paid ? 'paid' : 'unpaid'}" data-appointment-id="${appointment.id}"><div class="appointment-customer">${appointment.customer}</div><div class="appointment-service">${appointment.service}</div></div>`;
            } else if (isAvailable) {
                slotStateClass = 'available';
            } else {
                slotStateClass = reason === 'time-off' ? 'time-off' : 'unavailable';
            }

            slotDiv.className = `time-slot ${slotStateClass}`;
            slotDiv.innerHTML = `<div class="time-label">${timeString}</div><div class="time-content"><div class="stylist-slot ${slotStateClass}" data-time="${timeString}" data-stylist-id="${currentStylistId}">${slotContent}</div></div>`;
            container.appendChild(slotDiv);
        }
        addEventListenersToSlots();
    }

    function checkStylistAvailability(time) {
        const stylistSchedules = dailyData.schedules[currentStylistId] || [];
        const stylistTimeOffs = dailyData.timeOffs[currentStylistId] || [];
        if (stylistTimeOffs.some(off => time >= off.start && time < off.end)) return { isAvailable: false, reason: 'time-off' };
        if (stylistSchedules.some(schedule => time >= schedule.start && time < schedule.end)) return { isAvailable: true, reason: 'in-schedule' };
        return { isAvailable: false, reason: 'not-scheduled' };
    }

    function addEventListenersToSlots() {
        document.querySelectorAll('.stylist-slot.available').forEach(slot => {
            slot.addEventListener('click', function() {
                const time = this.dataset.time, stylist = stylists.find(s => s.id === currentStylistId);
                document.getElementById('modalStylist').textContent = stylist.name;
                document.getElementById('modalDate').textContent = new Intl.DateTimeFormat('fa-IR', { dateStyle: 'full' }).format(currentDate);
                document.getElementById('modalTime').textContent = time;
                new bootstrap.Modal(document.getElementById('bookingModal')).show();
            });
        });
        document.querySelectorAll('.appointment').forEach(appEl => {
            appEl.addEventListener('click', function(e) {
                e.stopPropagation();
                const appointmentId = parseInt(this.dataset.appointmentId), appData = dailyData.appointments.find(app => app.id === appointmentId), stylist = stylists.find(s => s.id === appData.stylistId);
                document.getElementById('appointmentDetails').innerHTML = `<p><strong>مشتری:</strong> ${appData.customer}</p><p><strong>آرایشگر:</strong> ${stylist.name}</p><p><strong>ساعت:</strong> ${appData.time}</p><p><strong>خدمت:</strong> ${appData.service}</p><p><strong>وضعیت پرداخت:</strong><span class="badge bg-${appData.paid ? 'success' : 'warning'}">${appData.paid ? 'پرداخت شده' : 'پرداخت نشده'}</span></p>${appData.description ? `<p><strong>توضیحات:</strong> ${appData.description}</p>` : ''}`;
                document.getElementById('appointmentModal').dataset.appointmentId = appointmentId;
                new bootstrap.Modal(document.getElementById('appointmentModal')).show();
            });
        });
    }
});
</script>
{% endblock content %}