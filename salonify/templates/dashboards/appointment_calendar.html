{% extends "dashboard_template.html" %}

{% block head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #f5f5f7; 
            margin: 0; 
            padding: 0;
            overflow-x: hidden;
        }
        
        .header { 
            background: white;
            border-bottom: 1px solid #e5e5e5;
            position: sticky; 
            top: 0; 
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 16px;
        }
        .menu-btn { 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer;
            padding: 8px;
        }
        .date-display { 
            font-size: 17px; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            cursor: pointer;
            color: #1c1c1e;
        }
        .date-display i { margin-left: 6px; font-size: 14px; }
        .logo { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 14px; 
            border-radius: 20px; 
            font-weight: 600; 
            font-size: 14px;
        }
        
        .stylists-header { 
            background: white;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            position: sticky;
            top: 57px;
            z-index: 999;
        }
        .time-column-header {
            width: 70px;
            min-width: 70px;
            background: white;
            border-left: 1px solid #e5e5e5;
        }
        .stylists-columns {
            display: flex;
            flex: 1;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .stylists-columns::-webkit-scrollbar { display: none; }
        .stylist-column-header {
            flex: 1;
            min-width: 200px;
            padding: 16px 12px;
            text-align: center;
            border-left: 1px solid #e5e5e5;
        }
        .stylist-avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            object-fit: cover; 
            margin: 0 auto 8px;
            border: 2px solid #e5e5e5;
        }
        .stylist-name { 
            font-size: 14px; 
            font-weight: 500; 
            color: #1c1c1e;
        }
        
        .calendar-grid {
            background: white;
            display: flex;
            min-height: calc(100vh - 160px);
        }
        .time-column {
            width: 70px;
            min-width: 70px;
            background: #fafafa;
            border-left: 1px solid #e5e5e5;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        .time-slot-label {
            height: 80px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 4px;
            font-size: 13px;
            color: #666;
            border-bottom: 1px solid #e5e5e5;
        }
        .time-slot-label.hour {
            font-weight: 600;
            color: #1c1c1e;
        }
        
        .appointments-grid {
            display: flex;
            flex: 1;
            position: relative;
            overflow-x: auto;
        }
        .stylist-day-column {
            flex: 1;
            min-width: 200px;
            position: relative;
            border-left: 1px solid #e5e5e5;
        }
        .time-grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            pointer-events: none;
        }
        .grid-line {
            height: 80px;
            border-bottom: 1px solid #e5e5e5;
        }
        .grid-line.half-hour {
            border-bottom: 1px dashed #f0f0f0;
        }
        
        .appointment-block {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
            overflow: hidden;
        }
        .appointment-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .appointment-block.paid {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .appointment-block.unpaid {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .appointment-time {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.95;
        }
        .appointment-customer {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .appointment-service {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .slot-click-area {
            position: absolute;
            left: 0;
            right: 0;
            height: 40px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .slot-click-area:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        .slot-click-area.unavailable {
            cursor: not-allowed;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.02) 10px,
                rgba(0,0,0,0.02) 20px
            );
        }
        .slot-click-area.time-off {
            cursor: not-allowed;
            background: repeating-linear-gradient(
                45deg,
                rgba(255,59,48,0.05),
                rgba(255,59,48,0.05) 10px,
                rgba(255,59,48,0.08) 10px,
                rgba(255,59,48,0.08) 20px
            );
        }
        
        .fab-container {
            position: fixed;
            bottom: 80px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
        }
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        .fab-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
        }
        .fab-secondary {
            background: white;
            color: #1c1c1e;
            font-size: 20px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal-content { border-radius: 16px; border: none; }
        .modal-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border-radius: 16px 16px 0 0;
            padding: 20px 24px;
        }
        .modal-title { font-weight: 600; font-size: 18px; }
        .modal-body { padding: 24px; }
        .info-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-row:last-child { border-bottom: none; }
        .info-label {
            font-weight: 600;
            color: #666;
            width: 100px;
        }
        .info-value {
            flex: 1;
            color: #1c1c1e;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
        }
        .btn-primary:hover { 
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); 
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #1c1c1e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
        }
        .btn-danger, .btn-success, .btn-warning {
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
        }
        .btn-danger { background: #ff3b30; }
        .btn-success { background: #34c759; }
        .btn-warning { background: #ff9500; color: white; }
    </style>
{% endblock head %}

{% block title %}تقویم نوبت‌ها{% endblock title %}

{% block content %}
    <div id="calendar-data-container" 
         data-salon-id="{{ salon_id }}" 
         data-prefix="{{ dashboard_prefix|safe }}">
    </div>

    <input type="text" id="hiddenDatePicker" class="d-none" />

    <div class="header">
        <div class="header-top">
            <button class="menu-btn"><i class="bi bi-list"></i></button>
            <div class="date-display" id="dateDisplay">
                <span></span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="logo">آلیزا</div>
        </div>
    </div>

    <div class="stylists-header">
        <div class="time-column-header"></div>
        <div class="stylists-columns" id="stylistsHeader"></div>
    </div>

    <div class="calendar-grid">
        <div class="time-column" id="timeLabels"></div>
        <div class="appointments-grid" id="appointmentsGrid"></div>
    </div>

    <div class="fab-container">
        <button class="fab fab-secondary" title="مدیریت تیم">
            <i class="bi bi-people"></i>
        </button>
        <button class="fab fab-secondary" title="تنظیمات تقویم">
            <i class="bi bi-calendar3"></i>
        </button>
        <button class="fab fab-primary" id="addAppointmentFab" title="نوبت جدید">
            <i class="bi bi-plus-lg"></i>
        </button>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ثبت نوبت جدید</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="info-row">
                        <div class="info-label">آرایشگر:</div>
                        <div class="info-value" id="modalStylist"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">تاریخ:</div>
                        <div class="info-value" id="modalDate"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ساعت:</div>
                        <div class="info-value" id="modalTime"></div>
                    </div>
                    <hr>
                    <form id="bookingForm">
                        <div class="mb-3">
                            <label class="form-label">نام مشتری</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">نوع خدمت</label>
                            <select class="form-select" id="serviceType" required>
                                <option value="">انتخاب کنید...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">توضیحات (اختیاری)</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="button" class="btn btn-primary" id="confirmBooking">ثبت نوبت</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="appointmentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">جزئیات نوبت</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="appointmentDetails"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="cancelAppointment">لغو نوبت</button>
                    <button type="button" class="btn btn-warning" id="editAppointment">ویرایش</button>
                    <button type="button" class="btn btn-success" id="markPaid">پرداخت شده</button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarContainer = document.getElementById('calendar-data-container');
    const salonId = calendarContainer.dataset.salonId;
    const dashboardPrefix = calendarContainer.dataset.prefix;
    const stylists = JSON.parse('{{ stylists_json|safe }}');
    
    let currentDate = new Date();
    let dailyData = {};

    initializeDatePicker();
    renderStylists();
    renderTimeLabels();
    fetchAndRenderDay(currentDate);

    function initializeDatePicker() {
        const picker = flatpickr("#hiddenDatePicker", {
            defaultDate: currentDate,
            dateFormat: "Y-m-d",
            onChange: function(selectedDates) {
                if (selectedDates.length > 0) {
                    currentDate = selectedDates[0];
                    fetchAndRenderDay(currentDate);
                }
            }
        });
        document.getElementById('dateDisplay').addEventListener('click', () => picker.open());
    }

    async function fetchAndRenderDay(date) {
        updateDateDisplay();
        showLoading();
        
        const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const url = `${dashboardPrefix}/api/calendar-data/salon/${salonId}/?date=${dateString}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network error');
            dailyData = await response.json();
            renderCalendarGrid();
        } catch (error) {
            console.error('Failed to fetch:', error);
            document.getElementById('appointmentsGrid').innerHTML = 
                '<div class="alert alert-danger m-3">خطا در بارگذاری اطلاعات</div>';
        } finally {
            hideLoading();
        }
    }
    
    function updateDateDisplay() {
        const formatter = new Intl.DateTimeFormat('fa-IR', { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long' 
        });
        document.querySelector('#dateDisplay span').textContent = formatter.format(currentDate);
    }

    function renderStylists() {
        const container = document.getElementById('stylistsHeader');
        container.innerHTML = stylists.map(s => `
            <div class="stylist-column-header" data-stylist-id="${s.id}">
                <img src="${s.avatar}" alt="${s.name}" class="stylist-avatar">
                <div class="stylist-name">${s.name}</div>
            </div>
        `).join('');
    }

    function renderTimeLabels() {
        if (!dailyData.salonIsOpen || !dailyData.openTime) {
            // Default times for initial render
            const times = [];
            for (let hour = 9; hour <= 18; hour++) {
                times.push(`${String(hour).padStart(2, '0')}:00`);
                if (hour < 18) times.push(`${String(hour).padStart(2, '0')}:30`);
            }
            renderTimeLabelsFromArray(times);
            return;
        }

        const [openHour] = dailyData.openTime.split(':').map(Number);
        const [closeHour] = dailyData.closeTime.split(':').map(Number);
        const times = [];
        
        for (let hour = openHour; hour <= closeHour; hour++) {
            times.push(`${String(hour).padStart(2, '0')}:00`);
            if (hour < closeHour) times.push(`${String(hour).padStart(2, '0')}:30`);
        }
        
        renderTimeLabelsFromArray(times);
    }

    function renderTimeLabelsFromArray(times) {
        const container = document.getElementById('timeLabels');
        container.innerHTML = times.map((time, i) => `
            <div class="time-slot-label ${i % 2 === 0 ? 'hour' : ''}">
                ${i % 2 === 0 ? time : ''}
            </div>
        `).join('');
    }

    function renderCalendarGrid() {
        const grid = document.getElementById('appointmentsGrid');
        
        if (!dailyData.salonIsOpen) {
            grid.innerHTML = `<div class="alert alert-warning m-3">${dailyData.message || 'سالن تعطیل است'}</div>`;
            return;
        }

        renderTimeLabels(); // Update time labels based on salon hours
        
        grid.innerHTML = stylists.map(stylist => {
            const stylistAppts = (dailyData.appointments || []).filter(a => a.stylistId === stylist.id);
            
            return `
                <div class="stylist-day-column" data-stylist-id="${stylist.id}">
                    ${renderGridLines()}
                    ${renderAppointments(stylistAppts)}
                    ${renderClickAreas(stylist.id)}
                </div>
            `;
        }).join('');
        
        attachEventListeners();
    }

    function renderGridLines() {
        const [openHour] = (dailyData.openTime || '09:00').split(':').map(Number);
        const [closeHour] = (dailyData.closeTime || '18:00').split(':').map(Number);
        const slots = (closeHour - openHour) * 2 + 1;
        
        let html = '<div class="time-grid-lines">';
        for (let i = 0; i < slots; i++) {
            html += `<div class="grid-line ${i % 2 === 1 ? 'half-hour' : ''}"></div>`;
        }
        html += '</div>';
        return html;
    }

    function renderAppointments(appts) {
        const [openHour] = (dailyData.openTime || '09:00').split(':').map(Number);
        const startMinutes = openHour * 60;
        
        return appts.map(appt => {
            const apptStartMinutes = timeToMinutes(appt.time);
            const apptEndMinutes = timeToMinutes(appt.endTime);
            const duration = apptEndMinutes - apptStartMinutes;
            
            const top = ((apptStartMinutes - startMinutes) / 30) * 80;
            const height = (duration / 30) * 80;
            
            return `
                <div class="appointment-block ${appt.paid ? 'paid' : 'unpaid'}" 
                     style="top: ${top}px; height: ${height}px;"
                     data-appointment-id="${appt.id}">
                    <div class="appointment-time">${appt.time} - ${appt.endTime}</div>
                    <div class="appointment-customer">${appt.customer}</div>
                    <div class="appointment-service">${appt.service}</div>
                </div>
            `;
        }).join('');
    }

    function renderClickAreas(stylistId) {
        const [openHour] = (dailyData.openTime || '09:00').split(':').map(Number);
        const [closeHour] = (dailyData.closeTime || '18:00').split(':').map(Number);
        const startMinutes = openHour * 60;
        
        let html = '';
        for (let hour = openHour; hour <= closeHour; hour++) {
            for (let minutes of [0, 30]) {
                if (hour === closeHour && minutes === 30) break;
                
                const time = `${String(hour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                const top = ((timeToMinutes(time) - startMinutes) / 30) * 80;
                
                const { isAvailable, reason } = checkAvailability(time, stylistId);
                const availClass = isAvailable ? '' : reason;
                
                html += `
                    <div class="slot-click-area ${availClass}" 
                         style="top: ${top}px;"
                         data-time="${time}"
                         data-stylist-id="${stylistId}"
                         data-available="${isAvailable}">
                    </div>
                `;
            }
        }
        return html;
    }

    function checkAvailability(time, stylistId) {
        const schedules = dailyData.schedules?.[stylistId] || [];
        const timeOffs = dailyData.timeOffs?.[stylistId] || [];
        
        // Check time off
        if (timeOffs.some(off => time >= off.start && time < off.end)) {
            return { isAvailable: false, reason: 'time-off' };
        }
        
        // Check schedule
        if (schedules.some(sch => time >= sch.start && time < sch.end)) {
            return { isAvailable: true, reason: '' };
        }
        
        return { isAvailable: false, reason: 'unavailable' };
    }

    function timeToMinutes(time) {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes;
    }

    function attachEventListeners() {
        document.querySelectorAll('.slot-click-area').forEach(slot => {
            slot.addEventListener('click', function() {
                if (this.dataset.available === 'false') return;
                
                const time = this.dataset.time;
                const stylistId = this.dataset.stylistId;
                const stylist = stylists.find(s => s.id === stylistId);
                
                document.getElementById('modalStylist').textContent = stylist.name;
                document.getElementById('modalDate').textContent = 
                    new Intl.DateTimeFormat('fa-IR', { dateStyle: 'full' }).format(currentDate);
                document.getElementById('modalTime').textContent = time;
                
                new bootstrap.Modal(document.getElementById('bookingModal')).show();
            });
        });
        
        document.querySelectorAll('.appointment-block').forEach(block => {
            block.addEventListener('click', function(e) {
                e.stopPropagation();
                const apptId = parseInt(this.dataset.appointmentId);
                const appt = dailyData.appointments.find(a => a.id === apptId);
                const stylist = stylists.find(s => s.id === appt.stylistId);
                
                document.getElementById('appointmentDetails').innerHTML = `
                    <div class="info-row">
                        <div class="info-label">مشتری:</div>
                        <div class="info-value">${appt.customer}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">آرایشگر:</div>
                        <div class="info-value">${stylist.name}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">زمان:</div>
                        <div class="info-value">${appt.time} - ${appt.endTime}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">خدمت:</div>
                        <div class="info-value">${appt.service}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">وضعیت:</div>
                        <div class="info-value">
                            <span class="badge bg-${appt.paid ? 'success' : 'warning'}">
                                ${appt.paid ? 'پرداخت شده' : 'پرداخت نشده'}
                            </span>
                        </div>
                    </div>
                    ${appt.description ? `
                    <div class="info-row">
                        <div class="info-label">توضیحات:</div>
                        <div class="info-value">${appt.description}</div>
                    </div>
                    ` : ''}
                `;
                
                new bootstrap.Modal(document.getElementById('appointmentModal')).show();
            });
        });
    }

    document.getElementById('addAppointmentFab').addEventListener('click', function() {
        if (stylists.length > 0) {
            document.getElementById('modalStylist').textContent = stylists[0].name;
            document.getElementById('modalDate').textContent = 
                new Intl.DateTimeFormat('fa-IR', { dateStyle: 'full' }).format(currentDate);
            document.getElementById('modalTime').textContent = dailyData.openTime || '10:00';
            
            new bootstrap.Modal(document.getElementById('bookingModal')).show();
        }
    });

    function showLoading() {
        const grid = document.getElementById('appointmentsGrid');
        grid.innerHTML = '<div class="loading-overlay"><div class="spinner"></div></div>';
    }

    function hideLoading() {
        const overlay = document.querySelector('.loading-overlay');
        if (overlay) overlay.remove();
    }
});
</script>
{% endblock content %}